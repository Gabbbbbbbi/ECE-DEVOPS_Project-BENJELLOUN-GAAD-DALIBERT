- name: Provision VM and run webapp
  hosts: all
  become: true

  vars:
    app_dir: /vagrant/webapp
    app_port: 3000
    vm_app_dir: /opt/webapp

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install packages
      apt:
        name:
          - curl
          - ca-certificates
          - gnupg
          - redis-server
          - rsync
        state: present

    - name: Enable and start Redis
      systemd:
        name: redis-server
        enabled: yes
        state: started

    - name: Add NodeSource GPG key
      shell: |
        mkdir -p /etc/apt/keyrings
        curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
      args:
        creates: /etc/apt/keyrings/nodesource.gpg

    - name: Add NodeSource repository
      shell: |
        echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" > /etc/apt/sources.list.d/nodesource.list
      args:
        creates: /etc/apt/sources.list.d/nodesource.list

    - name: Install NodeJS
      apt:
        update_cache: yes
        name: nodejs
        state: present

    - name: Create app directory in VM
      file:
        path: "{{ vm_app_dir }}"
        state: directory
        owner: vagrant
        group: vagrant
        mode: "0755"

    - name: Sync sources from /vagrant to VM directory (exclude node_modules)
      shell: |
        rsync -a --delete --exclude node_modules {{ app_dir }}/ {{ vm_app_dir }}/
      args:
        executable: /bin/bash

    - name: Install npm dependencies in VM filesystem
      shell: |
        cd {{ vm_app_dir }}
        npm ci
      args:
        executable: /bin/bash

    - name: Create systemd service
      template:
        src: templates/webapp.service.j2
        dest: /etc/systemd/system/webapp.service
        mode: "0644"

    - name: Reload systemd
      systemd:
        daemon_reload: yes

    - name: Enable and start webapp
      systemd:
        name: webapp
        enabled: yes
        state: restarted

    - name: Healthcheck
      uri:
        url: "http://localhost:{{ app_port }}/health"
        status_code: 200
      register: health
      retries: 20
      delay: 3
      until: health.status == 200
